<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Submapa Entrada 7</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    #mapa-container { position: relative; max-width: 1200px; margin: auto; }
    #mapa { width: 100%; display: block; }
    .icono-draggable { position: absolute; width: 32px; height: 32px; cursor: grab; }
  </style>
</head>
<body>
  <h1>Submapa - Entrada a la Infraoscuridad 7</h1>
  <div id="mapa-container">
    <img id="mapa" src="../assets/mapa_nacion_base.JPG" alt="Mapa de entrada" />
  </div>
  <button onclick="agregarIcono('ciudad')">Ciudad</button>
  <button onclick="agregarIcono('entrada')">Entrada</button>
  <button onclick="agregarIcono('mazmorra')">Mazmorra</button>
  <button onclick="borrarMapa()">Borrar Todo</button>

  <script>
    const mapaContainer = document.getElementById("mapa-container");
    const iconos = {
      ciudad: "../assets/iconos/ciudad.png",
      entrada: "../assets/iconos/entrada.png",
      mazmorra: "../assets/iconos/mazmorra.png"
    };

    function agregarIcono(tipo) {
      const icono = document.createElement("img");
      icono.src = iconos[tipo];
      icono.classList.add("icono-draggable");
      icono.style.left = "100px";
      icono.style.top = "100px";
      hacerDraggable(icono);
      mapaContainer.appendChild(icono);
      guardarEstado();
    }

    function hacerDraggable(elemento) {
      let offsetX, offsetY, isDragging = false;
      elemento.addEventListener("mousedown", e => {
        isDragging = true;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        elemento.style.cursor = "grabbing";
      });
      document.addEventListener("mousemove", e => {
        if (!isDragging) return;
        const rect = mapaContainer.getBoundingClientRect();
        elemento.style.left = `${e.clientX - rect.left - offsetX}px`;
        elemento.style.top = `${e.clientY - rect.top - offsetY}px`;
      });
      document.addEventListener("mouseup", () => {
        if (isDragging) {
          isDragging = false;
          elemento.style.cursor = "grab";
          guardarEstado();
        }
      });
    }

    function guardarEstado() {
      const estado = [];
      mapaContainer.querySelectorAll(".icono-draggable").forEach(icono => {
        estado.push({
          src: icono.src,
          left: icono.style.left,
          top: icono.style.top
        });
      });
      localStorage.setItem("iconosMapa7", JSON.stringify(estado));
    }

    function cargarEstado() {
      const estado = JSON.parse(localStorage.getItem("iconosMapa7"));
      if (!estado) return;
      estado.forEach(({ src, left, top }) => {
        const icono = document.createElement("img");
        icono.src = src;
        icono.classList.add("icono-draggable");
        icono.style.left = left;
        icono.style.top = top;
        hacerDraggable(icono);
        mapaContainer.appendChild(icono);
      });
    }

    function borrarMapa() {
      if (!confirm("Â¿Borrar todos los iconos del mapa?")) return;
      mapaContainer.querySelectorAll(".icono-draggable").forEach(e => e.remove());
      localStorage.removeItem("iconosMapa7");
    }

    window.onload = cargarEstado;
  </script>
</body>
</html>
