<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de la Nación</title>
  <link rel="stylesheet" href="../styles/mapa.css">
  <style>
    #mapa-container {
      position: relative;
      display: inline-block;
    }

    .icono-draggable {
      position: absolute;
      width: 32px;
      height: 32px;
      cursor: move;
    }

    #mapa-actions {
      margin-top: 10px;
    }

    #mapa-actions button {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>Mapa de la Nación</h1>

  <div id="mapa-container">
    <img src="../assets/mapa_nacion_base.JPG" alt="Mapa base" id="mapa-base">
  </div>

  <div id="mapa-actions">
    <button onclick="guardarMapa()">Guardar mapa</button>
    <input type="file" id="cargarMapaInput" accept=".json" onchange="cargarMapa()" style="display: none;">
    <button onclick="document.getElementById('cargarMapaInput').click()">Cargar mapa</button>
    <button onclick="borrarMapa()">Borrar mapa</button>
  </div>

  <div id="iconos">
    <p>Haz clic para añadir:</p>
    <button onclick="crearIcono('Ciudad')">🏙 Ciudad</button>
    <button onclick="crearIcono('Pueblo')">🏘 Pueblo</button>
    <button onclick="crearIcono('Mazmorra')">🕳 Mazmorra</button>
    <button onclick="crearIcono('Entrada_infraoscuridad')">🌀 Entrada Infraoscuridad</button>
    <button onclick="crearIcono('Puesto_defensivo')">🛡 Puesto defensivo</button>
    <button onclick="crearIcono('Ruinas')">🏚 Ruinas</button>
  </div>

  <script>
    const contenedor = document.getElementById("mapa-container");

    function crearIcono(tipo, x = 50, y = 50) {
      const icono = document.createElement("img");
      icono.src = `../assets/iconos/${tipo}.svg`;
      icono.classList.add("icono-draggable");
      icono.style.left = x + "px";
      icono.style.top = y + "px";
      icono.setAttribute("data-tipo", tipo);

      hacerDraggable(icono);
      contenedor.appendChild(icono);
      guardarLocalmente();
    }

    function hacerDraggable(elemento) {
      let offsetX, offsetY;

      elemento.onmousedown = function (e) {
        offsetX = e.clientX - parseInt(elemento.style.left);
        offsetY = e.clientY - parseInt(elemento.style.top);

        document.onmousemove = function (e) {
          elemento.style.left = (e.clientX - offsetX) + "px";
          elemento.style.top = (e.clientY - offsetY) + "px";
        };

        document.onmouseup = function () {
          document.onmousemove = null;
          document.onmouseup = null;
          guardarLocalmente();
        };
      };
    }

    function guardarLocalmente() {
      const iconos = document.querySelectorAll(".icono-draggable");
      const datos = [];

      iconos.forEach(icono => {
        datos.push({
          tipo: icono.getAttribute("data-tipo"),
          x: parseInt(icono.style.left),
          y: parseInt(icono.style.top)
        });
      });

      localStorage.setItem("iconosMapa", JSON.stringify(datos));
    }

    function cargarDesdeLocal() {
      const datos = localStorage.getItem("iconosMapa");
      if (!datos) return;

      JSON.parse(datos).forEach(icono => {
        crearIcono(icono.tipo, icono.x, icono.y);
      });
    }

    function guardarMapa() {
      const datos = localStorage.getItem("iconosMapa");
      if (!datos) {
        alert("No hay iconos para guardar.");
        return;
      }

      const blob = new Blob([datos], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "mapa_nacion.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function cargarMapa() {
      const archivo = document.getElementById("cargarMapaInput").files[0];
      if (!archivo) return;

      const lector = new FileReader();
      lector.onload = function (e) {
        const datos = JSON.parse(e.target.result);
        localStorage.setItem("iconosMapa", JSON.stringify(datos));

        // Limpiar y recargar
        document.querySelectorAll(".icono-draggable").forEach(e => e.remove());
        datos.forEach(icono => crearIcono(icono.tipo, icono.x, icono.y));
      };
      lector.readAsText(archivo);
    }

    function borrarMapa() {
      if (!confirm("¿Seguro que quieres borrar todos los iconos del mapa?")) return;

      const iconos = document.querySelectorAll(".icono-draggable");
      iconos.forEach(icono => icono.remove());
      localStorage.removeItem("iconosMapa");
    }

    // Obtener ID de nación desde URL
    function obtenerIDNacion() {
      const ruta = window.location.pathname;
      const partes = ruta.split("/");
      let archivo = partes[partes.length - 1];

      if (archivo === "") return null;

      // Si viene como base.html?mapa=7
      const params = new URLSearchParams(window.location.search);
      if (archivo.startsWith("base") && params.has("mapa")) {
        return params.get("mapa");
      }

      // Si viene como 1.html
      if (archivo.includes(".html")) {
        return archivo.split(".")[0];
      }

      return null;
    }

    const idNacion = obtenerIDNacion();
    if (idNacion !== null) {
      localStorage.setItem("idNacionActual", idNacion);
      console.log("ID de nación actual guardado:", idNacion);
    }

    // Cargar mapa automáticamente al entrar
    window.onload = cargarDesdeLocal;
  </script>
</body>
</html>