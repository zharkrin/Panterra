<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Submapa de Nación</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #mapa-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-image: url('../assets/mapa_nacion_base.JPG');
      background-size: cover;
      background-position: center;
    }
    .icono-draggable {
      position: absolute;
      width: 32px;
      height: 32px;
      cursor: move;
    }
    #iconos {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
    }
    #mapa-actions {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="iconos">
    <img src="../assets/iconos/Ciudad.svg" class="icono-draggable" draggable="true" data-icono="Ciudad" alt="Ciudad" />
    <img src="../assets/iconos/Pueblo.svg" class="icono-draggable" draggable="true" data-icono="Pueblo" alt="Pueblo" />
    <img src="../assets/iconos/Puesto.svg" class="icono-draggable" draggable="true" data-icono="Puesto" alt="Puesto Defensivo" />
    <img src="../assets/iconos/Ruinas.svg" class="icono-draggable" draggable="true" data-icono="Ruinas" alt="Ruinas" />
    <img src="../assets/iconos/Infraoscuridad.svg" class="icono-draggable" draggable="true" data-icono="Infraoscuridad" alt="Entrada Infraoscuridad" />
    <img src="../assets/iconos/Mazmorra.svg" class="icono-draggable" draggable="true" data-icono="Mazmorra" alt="Mazmorra" />
  </div>

  <div id="mapa-actions">
    <button onclick="guardarMapa()">Guardar mapa</button>
    <input type="file" id="cargarMapaInput" accept=".json" onchange="cargarMapa()" style="display: none;">
    <button onclick="document.getElementById('cargarMapaInput').click()">Cargar mapa</button>
    <button onclick="borrarMapa()">Borrar mapa</button>
  </div>

  <div id="mapa-container"></div>

  <script>
    // Arrastrar iconos desde el menú
    const iconos = document.querySelectorAll(".icono-draggable");
    iconos.forEach(icono => {
      icono.addEventListener("dragstart", e => {
        e.dataTransfer.setData("icono", icono.getAttribute("data-icono"));
      });
    });

    const contenedor = document.getElementById("mapa-container");
    contenedor.addEventListener("dragover", e => e.preventDefault());

    contenedor.addEventListener("drop", e => {
      e.preventDefault();
      const tipo = e.dataTransfer.getData("icono");
      const nuevo = document.createElement("img");
      nuevo.src = `../assets/iconos/${tipo}.svg`;
      nuevo.className = "icono-draggable";
      nuevo.setAttribute("data-icono", tipo);
      nuevo.style.left = e.offsetX + "px";
      nuevo.style.top = e.offsetY + "px";
      nuevo.draggable = true;

      nuevo.addEventListener("dragstart", ev => {
        ev.dataTransfer.setData("text/plain", null);
        ev.dataTransfer.setDragImage(new Image(), 0, 0);
        ev.dataTransfer.setData("dragging", "true");
        ev.dataTransfer.setData("offsetX", ev.offsetX);
        ev.dataTransfer.setData("offsetY", ev.offsetY);
        nuevo.classList.add("dragging");
      });

      nuevo.addEventListener("dragend", ev => {
        nuevo.style.left = ev.pageX - contenedor.offsetLeft - parseInt(ev.dataTransfer.getData("offsetX")) + "px";
        nuevo.style.top = ev.pageY - contenedor.offsetTop - parseInt(ev.dataTransfer.getData("offsetY")) + "px";
        nuevo.classList.remove("dragging");
        guardarEnLocalStorage();
      });

      contenedor.appendChild(nuevo);
      guardarEnLocalStorage();
    });

    function guardarEnLocalStorage() {
      const iconos = contenedor.querySelectorAll(".icono-draggable");
      const datos = Array.from(iconos).map(icono => ({
        tipo: icono.getAttribute("data-icono"),
        x: parseInt(icono.style.left),
        y: parseInt(icono.style.top)
      }));
      localStorage.setItem("iconosMapa", JSON.stringify(datos));
    }

    function cargarDesdeLocalStorage() {
      const datos = JSON.parse(localStorage.getItem("iconosMapa"));
      if (!datos) return;
      datos.forEach(d => {
        const nuevo = document.createElement("img");
        nuevo.src = `../assets/iconos/${d.tipo}.svg`;
        nuevo.className = "icono-draggable";
        nuevo.setAttribute("data-icono", d.tipo);
        nuevo.style.left = d.x + "px";
        nuevo.style.top = d.y + "px";
        nuevo.draggable = true;

        nuevo.addEventListener("dragstart", ev => {
          ev.dataTransfer.setData("text/plain", null);
          ev.dataTransfer.setDragImage(new Image(), 0, 0);
          ev.dataTransfer.setData("dragging", "true");
          ev.dataTransfer.setData("offsetX", ev.offsetX);
          ev.dataTransfer.setData("offsetY", ev.offsetY);
          nuevo.classList.add("dragging");
        });

        nuevo.addEventListener("dragend", ev => {
          nuevo.style.left = ev.pageX - contenedor.offsetLeft - parseInt(ev.dataTransfer.getData("offsetX")) + "px";
          nuevo.style.top = ev.pageY - contenedor.offsetTop - parseInt(ev.dataTransfer.getData("offsetY")) + "px";
          nuevo.classList.remove("dragging");
          guardarEnLocalStorage();
        });

        contenedor.appendChild(nuevo);
      });
    }

    function guardarMapa() {
      const datos = localStorage.getItem("iconosMapa");
      const blob = new Blob([datos], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "mapa_nacion.json";
      a.click();
    }

    function cargarMapa() {
      const input = document.getElementById("cargarMapaInput");
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        localStorage.setItem("iconosMapa", e.target.result);
        contenedor.innerHTML = ""; // limpiar mapa actual
        cargarDesdeLocalStorage();
      };
      reader.readAsText(file);
    }

    function borrarMapa() {
      if (!confirm("¿Seguro que quieres borrar todos los iconos del mapa?")) return;
      const iconos = contenedor.querySelectorAll(".icono-draggable");
      iconos.forEach(icono => contenedor.removeChild(icono));
      localStorage.removeItem("iconosMapa");
    }

    window.onload = cargarDesdeLocalStorage;
  </script>
</body>
</html>