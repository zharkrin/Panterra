<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Submapa de Nación</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    #mapa-container {
      position: relative;
      width: 100%;
      height: 90vh;
      background-image: url("../assets/mapa_nacion_base.JPG");
      background-size: cover;
      background-position: center;
      border: 2px solid #444;
      overflow: hidden;
    }

    .icono-draggable {
      position: absolute;
      width: 32px;
      height: 32px;
      cursor: move;
    }

    #iconos-disponibles {
      display: flex;
      gap: 10px;
      padding: 10px;
      background-color: #f0f0f0;
      border-bottom: 2px solid #444;
    }

    #iconos-disponibles img {
      width: 32px;
      height: 32px;
      cursor: grab;
    }

    #mapa-actions {
      padding: 10px;
      background-color: #ddd;
      display: flex;
      gap: 10px;
      border-top: 2px solid #444;
    }

    button {
      padding: 6px 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="iconos-disponibles">
    <img src="../assets/iconos/Ciudad.svg" class="icono-draggable" draggable="true" data-icono="Ciudad" alt="Ciudad" />
    <img src="../assets/iconos/Pueblo.svg" class="icono-draggable" draggable="true" data-icono="Pueblo" alt="Pueblo" />
    <img src="../assets/iconos/Entrada_infraoscuridad.svg" class="icono-draggable" draggable="true" data-icono="Entrada_infraoscuridad" alt="Entrada a la Infraoscuridad" />
    <img src="../assets/iconos/Mazmorra.svg" class="icono-draggable" draggable="true" data-icono="Mazmorra" alt="Mazmorra" />
    <img src="../assets/iconos/Puesto_defensivo.svg" class="icono-draggable" draggable="true" data-icono="Puesto_defensivo" alt="Puesto defensivo" />
    <img src="../assets/iconos/Ruinas.svg" class="icono-draggable" draggable="true" data-icono="Ruinas" alt="Ruinas" />
  </div>

  <div id="mapa-container"></div>

  <div id="mapa-actions">
    <button onclick="guardarMapa()">Guardar mapa</button>
    <input type="file" id="cargarMapaInput" accept=".json" onchange="cargarMapa()" style="display: none;">
    <button onclick="document.getElementById('cargarMapaInput').click()">Cargar mapa</button>
    <button onclick="borrarMapa()">Borrar mapa</button>
  </div>

  <script>
    const contenedor = document.getElementById("mapa-container");
    const iconos = document.querySelectorAll("#iconos-disponibles img");

    iconos.forEach(icono => {
      icono.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", icono.dataset.icono);
      });
    });

    contenedor.addEventListener("dragover", e => {
      e.preventDefault();
    });

    contenedor.addEventListener("drop", e => {
      e.preventDefault();
      const tipo = e.dataTransfer.getData("text/plain");
      const nuevoIcono = document.createElement("img");
      nuevoIcono.src = `../assets/iconos/${tipo}.svg`;
      nuevoIcono.className = "icono-draggable";
      nuevoIcono.setAttribute("draggable", "true");
      nuevoIcono.dataset.icono = tipo;
      nuevoIcono.style.left = `${e.offsetX - 16}px`;
      nuevoIcono.style.top = `${e.offsetY - 16}px`;
      contenedor.appendChild(nuevoIcono);

      hacerArrastrable(nuevoIcono);
      guardarIconosEnLocalStorage();
    });

    function hacerArrastrable(elemento) {
      let offsetX, offsetY;

      elemento.addEventListener("dragstart", e => {
        offsetX = e.offsetX;
        offsetY = e.offsetY;
      });

      elemento.addEventListener("dragend", e => {
        const rect = contenedor.getBoundingClientRect();
        const x = e.pageX - rect.left - offsetX;
        const y = e.pageY - rect.top - offsetY;
        elemento.style.left = `${x}px`;
        elemento.style.top = `${y}px`;
        guardarIconosEnLocalStorage();
      });
    }

    function guardarIconosEnLocalStorage() {
      const iconos = contenedor.querySelectorAll(".icono-draggable");
      const datos = Array.from(iconos).map(icono => ({
        tipo: icono.dataset.icono,
        left: icono.style.left,
        top: icono.style.top
      }));
      localStorage.setItem("iconosMapa", JSON.stringify(datos));
    }

    function cargarIconosDesdeLocalStorage() {
      const datos = JSON.parse(localStorage.getItem("iconosMapa"));
      if (!datos) return;

      datos.forEach(dato => {
        const icono = document.createElement("img");
        icono.src = `../assets/iconos/${dato.tipo}.svg`;
        icono.className = "icono-draggable";
        icono.setAttribute("draggable", "true");
        icono.dataset.icono = dato.tipo;
        icono.style.left = dato.left;
        icono.style.top = dato.top;
        contenedor.appendChild(icono);
        hacerArrastrable(icono);
      });
    }

    function guardarMapa() {
      const datos = localStorage.getItem("iconosMapa");
      if (!datos) {
        alert("No hay datos para guardar.");
        return;
      }
      const blob = new Blob([datos], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const enlace = document.createElement("a");
      enlace.href = url;
      enlace.download = "mapa_guardado.json";
      enlace.click();
      URL.revokeObjectURL(url);
    }

    function cargarMapa() {
      const archivo = document.getElementById("cargarMapaInput").files[0];
      if (!archivo) return;

      const lector = new FileReader();
      lector.onload = e => {
        const datos = JSON.parse(e.target.result);
        localStorage.setItem("iconosMapa", JSON.stringify(datos));
        contenedor.innerHTML = "";
        datos.forEach(dato => {
          const icono = document.createElement("img");
          icono.src = `../assets/iconos/${dato.tipo}.svg`;
          icono.className = "icono-draggable";
          icono.setAttribute("draggable", "true");
          icono.dataset.icono = dato.tipo;
          icono.style.left = dato.left;
          icono.style.top = dato.top;
          contenedor.appendChild(icono);
          hacerArrastrable(icono);
        });
      };
      lector.readAsText(archivo);
    }

    function borrarMapa() {
      if (!confirm("¿Seguro que quieres borrar todos los iconos del mapa?")) return;
      contenedor.innerHTML = "";
      localStorage.removeItem("iconosMapa");
    }

    window.addEventListener("DOMContentLoaded", cargarIconosDesdeLocalStorage);
  </script>
</body>
</html>