<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Submapa de Nación</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    #mapa-container {
      position: relative;
      width: 100%;
      height: 90vh;
      background-image: url("../assets/mapa_nacion_base.JPG");
      background-size: cover;
      background-position: center;
      border: 2px solid #333;
      overflow: hidden;
    }

    #iconos {
      display: flex;
      gap: 10px;
      padding: 10px;
      background-color: #ddd;
      border-top: 2px solid #333;
    }

    .icono-draggable {
      width: 32px;
      height: 32px;
      cursor: grab;
      position: relative;
    }

    #mapa-actions {
      margin-top: 10px;
      padding: 10px;
      background-color: #eee;
    }

    button {
      padding: 6px 12px;
      font-size: 14px;
      margin-right: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="mapa-container" ondragover="permitirSoltar(event)" ondrop="soltar(event)">
    <!-- Iconos colocados aparecerán aquí -->
  </div>

  <div id="iconos">
    <img src="../assets/iconos/Ciudad.svg" class="icono-draggable" draggable="true" data-icono="Ciudad" alt="Ciudad" />
    <img src="../assets/iconos/Pueblo.svg" class="icono-draggable" draggable="true" data-icono="Pueblo" alt="Pueblo" />
    <img src="../assets/iconos/Puesto_defensivo.svg" class="icono-draggable" draggable="true" data-icono="Puesto_defensivo" alt="Puesto Defensivo" />
    <img src="../assets/iconos/Ruinas.svg" class="icono-draggable" draggable="true" data-icono="Ruinas" alt="Ruinas" />
    <img src="../assets/iconos/Entrada_infraoscuridad.svg" class="icono-draggable" draggable="true" data-icono="Entrada_infraoscuridad" alt="Entrada Infraoscuridad" />
    <img src="../assets/iconos/Mazmorra.svg" class="icono-draggable" draggable="true" data-icono="Mazmorra" alt="Mazmorra" />
  </div>

  <div id="mapa-actions">
  <button onclick="guardarMapa()">Guardar mapa</button>
<input type="file" id="cargarMapaInput" accept=".json" onchange="cargarMapa()" style="display: none;">
<button onclick="document.getElementById('cargarMapaInput').click()">Cargar mapa</button>
<button onclick="borrarMapa()">Borrar mapa</button>
  </div>

  <script>
    let iconoArrastrado = null;

    function permitirSoltar(event) {
      event.preventDefault();
    }

    function dragStart(event) {
      iconoArrastrado = event.target;
    }

    function dragEnd(event) {
      iconoArrastrado = null;
    }

    function soltar(event) {
      event.preventDefault();
      const tipo = iconoArrastrado.dataset.icono;
      const nuevoIcono = iconoArrastrado.cloneNode(true);

      nuevoIcono.style.position = 'absolute';
      nuevoIcono.style.left = (event.offsetX - 16) + 'px';
      nuevoIcono.style.top = (event.offsetY - 16) + 'px';
      nuevoIcono.classList.add('icono-draggable');
      nuevoIcono.setAttribute('draggable', true);
      nuevoIcono.addEventListener('dragstart', dragStart);
      nuevoIcono.addEventListener('dragend', dragEnd);

      document.getElementById('mapa-container').appendChild(nuevoIcono);
      guardarPosiciones();
    }

    function guardarPosiciones() {
      const iconos = document.querySelectorAll('#mapa-container .icono-draggable');
      const posiciones = [];

      iconos.forEach(icono => {
        posiciones.push({
          tipo: icono.dataset.icono,
          left: icono.style.left,
          top: icono.style.top
        });
      });

      localStorage.setItem('iconosMapa', JSON.stringify(posiciones));
    }

    function cargarDesdeLocalStorage() {
      const datos = localStorage.getItem('iconosMapa');
      if (!datos) return;

      try {
        const posiciones = JSON.parse(datos);
        posiciones.forEach(info => {
          const base = document.querySelector(`img[data-icono="${info.tipo}"]`);
          if (!base) return;

          const nuevoIcono = base.cloneNode(true);
          nuevoIcono.style.position = 'absolute';
          nuevoIcono.style.left = info.left;
          nuevoIcono.style.top = info.top;
          nuevoIcono.classList.add('icono-draggable');
          nuevoIcono.setAttribute('draggable', true);
          nuevoIcono.addEventListener('dragstart', dragStart);
          nuevoIcono.addEventListener('dragend', dragEnd);

          document.getElementById('mapa-container').appendChild(nuevoIcono);
        });
      } catch (e) {
        console.error("Error al cargar desde localStorage:", e);
      }
    }

    function guardarMapa() {
      const iconos = document.querySelectorAll('#mapa-container .icono-draggable');
      const datos = [];

      iconos.forEach(icono => {
        datos.push({
          tipo: icono.dataset.icono,
          left: icono.style.left,
          top: icono.style.top
        });
      });

      const json = JSON.stringify(datos, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "mapa_guardado.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function cargarMapa() {
      const input = document.getElementById('cargarMapaInput');
      const archivo = input.files[0];
      if (!archivo) return;

      const lector = new FileReader();
      lector.onload = function(e) {
        const contenido = e.target.result;
        try {
          const datos = JSON.parse(contenido);
          datos.forEach(info => {
            const base = document.querySelector(`img[data-icono="${info.tipo}"]`);
            if (!base) return;

            const nuevoIcono = base.cloneNode(true);
            nuevoIcono.style.position = 'absolute';
            nuevoIcono.style.left = info.left;
            nuevoIcono.style.top = info.top;
            nuevoIcono.classList.add('icono-draggable');
            nuevoIcono.setAttribute('draggable', true);
            nuevoIcono.addEventListener('dragstart', dragStart);
            nuevoIcono.addEventListener('dragend', dragEnd);
            document.getElementById('mapa-container').appendChild(nuevoIcono);
          });
          guardarPosiciones();
        } catch (err) {
          alert("Archivo inválido.");
        }
      };
      lector.readAsText(archivo);
    }

    // Cargar iconos guardados automáticamente
    window.onload = cargarDesdeLocalStorage;
  </script>
  function borrarMapa() {
  if (!confirm("¿Seguro que quieres borrar todos los iconos del mapa?")) return;

  const contenedor = document.getElementById("mapa-container");
  const iconos = contenedor.querySelectorAll(".icono-draggable");

  iconos.forEach(icono => contenedor.removeChild(icono));

  localStorage.removeItem("iconosMapa");
}
</body>
</html>